(()=>{var e={};e.id=602,e.ids=[602],e.modules={2734:(e,t,r)=>{"use strict";r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{GET:()=>o,POST:()=>c});var n=r(32496),a=r(83968),i=e([n,a]);async function o(e){try{let e=await (0,n.Ux)();if(!e)return(0,n.WX)("Unauthorized",401);let t=await (0,a.j$)(e);return(0,n.$y)({conversations:t})}catch(e){return console.error("GET /api/conversations",e),(0,n.WX)("Internal server error",500)}}async function c(e){try{let t=await (0,n.Ux)();if(!t)return(0,n.WX)("Unauthorized",401);let{petId:r,ownerId:s}=await e.json();if(!r||!s)return(0,n.WX)("petId and ownerId required",400);let i=await (0,a.FA)(r,t,s);return(0,n.$y)({conversationId:i})}catch(e){return console.error("POST /api/conversations",e),(0,n.WX)("Internal server error",500)}}[n,a]=i.then?(await i)():i,s()}catch(e){s(e)}})},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{"use strict";e.exports=require("node:buffer")},5069:(e,t,r)=>{"use strict";r.a(e,async(e,s)=>{try{r.d(t,{db:()=>p}),r(95710);var n=r(98614),a=r(40586),i=r(30650),o=r(64939),c=e([o]);let u=new(o=(c.then?(await c)():c)[0]).Pool({connectionString:process.env.DATABASE_URL}),d=new n.a({pool:u}),p=new a._$({dialect:d,plugins:[new i.E]});s()}catch(e){s(e)}})},9550:(e,t,r)=>{"use strict";r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{patchFetch:()=>u,routeModule:()=>d,serverHooks:()=>w,workAsyncStorage:()=>p,workUnitAsyncStorage:()=>l});var n=r(96559),a=r(48088),i=r(37719),o=r(2734),c=e([o]);o=(c.then?(await c)():c)[0];let d=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/conversations/route",pathname:"/api/conversations",filename:"route",bundlePath:"app/api/conversations/route"},resolvedPagePath:"/home/marty/turing/4-module/4-sprint/match4paws/src/app/api/conversations/route.ts",nextConfigOutput:"",userland:o}),{workAsyncStorage:p,workUnitAsyncStorage:l,serverHooks:w}=d;function u(){return(0,i.patchFetch)({workAsyncStorage:p,workUnitAsyncStorage:l})}s()}catch(e){s(e)}})},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},21820:e=>{"use strict";e.exports=require("os")},24476:(e,t,r)=>{"use strict";r.a(e,async(e,s)=>{try{r.d(t,{bx:()=>u,ce:()=>p,d$:()=>d,eg:()=>l,iU:()=>i,kg:()=>c,kl:()=>o});var n=r(5069),a=e([n]);async function i(e){return await n.db.selectFrom("users").select(["id"]).where("auth0Id","=",e).executeTakeFirst()||null}async function o(e){return await n.db.selectFrom("users").selectAll().where("id","=",e).executeTakeFirst()||null}async function c(e){await n.db.insertInto("users").values({auth0Id:e}).onConflict(e=>e.column("auth0Id").doNothing()).execute()}async function u(e){await n.db.updateTable("users").set({lastLoginAt:new Date}).where("auth0Id","=",e).execute()}async function d(e){let t=await n.db.selectFrom("users").select(["onboardingCompleted"]).where("auth0Id","=",e).executeTakeFirst();return t?.onboardingCompleted??!1}async function p(e){let{userId:t,...r}=e;await n.db.updateTable("users").set({onboardingCompleted:!0,onboardingCompletedAt:new Date,...r}).where("auth0Id","=",t).execute()}async function l(e,t){Object.keys(t).length&&await n.db.updateTable("users").set({...t}).where("id","=",e).execute()}n=(a.then?(await a)():a)[0],s()}catch(e){s(e)}})},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},32496:(e,t,r)=>{"use strict";r.a(e,async(e,s)=>{try{r.d(t,{$y:()=>d,Ux:()=>c,WX:()=>u,l:()=>p});var n=r(32190),a=r(93109),i=r(24476),o=e([i]);async function c(e){let t=await a.J.getSession();if(!t?.user?.sub)return null;let r=await (0,i.iU)(t.user.sub);return r?.id??null}function u(e,t){return n.NextResponse.json({error:e},{status:t})}function d(e){return n.NextResponse.json({success:!0,...e})}async function p(e,t){try{let r=await e.json();for(let e of t)if(!r[e])return u(`Missing required field: ${String(e)}`,400);return r}catch(e){return u("Invalid JSON body",400)}}i=(o.then?(await o)():o)[0],s()}catch(e){s(e)}})},33873:e=>{"use strict";e.exports=require("path")},37067:e=>{"use strict";e.exports=require("node:http")},44708:e=>{"use strict";e.exports=require("node:https")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},57975:e=>{"use strict";e.exports=require("node:util")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},64939:e=>{"use strict";e.exports=import("pg")},77598:e=>{"use strict";e.exports=require("node:crypto")},78335:()=>{},78474:e=>{"use strict";e.exports=require("node:events")},83968:(e,t,r)=>{"use strict";r.a(e,async(e,s)=>{try{r.d(t,{FA:()=>c,j$:()=>o,ly:()=>u});var n=r(5069),a=r(15400),i=e([n]);async function o(e){return n.db.selectFrom("conversations as c").leftJoin("petImages as pi",e=>e.onRef("pi.petId","=","c.petId").on("pi.orderIdx","=",0)).leftJoin("messages as m","m.conversationId","c.id").select(["c.id","c.petId","c.adopterId","c.ownerId","c.createdAt","pi.url as thumbUrl",(0,a.l)`count(*) filter (
        where m.read_at is null
          and m.sender_id <> ${e}
      )`.as("unread"),(0,a.l)`max(m.sent_at)`.as("lastSentAt"),(0,a.l)`max(m.body)`.as("lastBody")]).where(t=>t.or([t("c.adopterId","=",e),t("c.ownerId","=",e)])).groupBy(["c.id","c.petId","c.adopterId","c.ownerId","c.createdAt","pi.url"]).orderBy((0,a.l)`max(m.sent_at)`,"desc").execute()}async function c(e,t,r){let s=await n.db.selectFrom("conversations").select("id").where("petId","=",e).where("adopterId","=",t).where("ownerId","=",r).executeTakeFirst();if(s)return s.id;let{id:a}=await n.db.insertInto("conversations").values({petId:e,adopterId:t,ownerId:r}).returning("id").executeTakeFirstOrThrow();return a}async function u(e){await n.db.transaction().execute(async t=>{await t.deleteFrom("messages").where("conversationId","=",e).execute(),await t.deleteFrom("conversations").where("id","=",e).execute()})}n=(i.then?(await i)():i)[0],s()}catch(e){s(e)}})},93109:(e,t,r)=>{"use strict";r.d(t,{J:()=>s});let s=new(r(94420)).OF({domain:process.env.AUTH0_DOMAIN,clientId:process.env.AUTH0_CLIENT_ID,clientSecret:process.env.AUTH0_CLIENT_SECRET,secret:process.env.AUTH0_SECRET,appBaseUrl:process.env.APP_BASE_URL})},96487:()=>{},96559:(e,t,r)=>{"use strict";e.exports=r(44870)}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[719,420,326],()=>r(9550));module.exports=s})();